#!/usr/bin/env sh

set -e

inst() {
  url="$1"
  sha256="$2"
  tar_path="$3"
  dest_path="$4"
  strip_comp="$5"
  tmp_dir="$(mktemp -d)"

  echo "=> Downloading \"$url\""
  curl -sL "$url" -o "$tmp_dir/temp.tar.gz"

  echo "=> Checking checksum"
  echo "$sha256  $tmp_dir/temp.tar.gz" | sha256sum -c -

  echo "=> Extracting to \"$dest_path\""
  tar -xzf "$tmp_dir/temp.tar.gz" -C "$dest_path" "$tar_path" --strip-components="$strip_comp"

  echo "=> Cleanup temp dir \"$tmp_dir\""
  rm -r "$tmp_dir"

  echo "=> Installed!"
}

inst_bin() {
  url="$1"
  sha256="$2"
  bin_name="$3"
  dest_path="$4"
  tmp_dir="$(mktemp -d)"

  echo "=> Downloading \"$url\""
  curl -sL "$url" -o "$tmp_dir/$bin_name"

  echo "=> Checking checksum"
  echo "$sha256  $tmp_dir/$bin_name" | sha256sum -c -
  
  echo "=> Moving binary to \""$dest_path/$bin_name"\"" 
  cp "$tmp_dir/$bin_name" "$dest_path/$bin_name"

  echo "=> Make binary executable"
  chmod +x "$dest_path/$bin_name"

  echo "=> Cleanup temp dir \"$tmp_dir\""
  rm -r "$tmp_dir"

  echo "=> Installed!"
}

echo "==> Install manual binaries"
mkdir -v -p "$HOME"/.local/bin/
inst_bin \
  https://github.com/docker/docker-credential-helpers/releases/download/v0.9.4/docker-credential-secretservice-v0.9.4.linux-amd64 \
  747dbdca622f880003559369edf7bcbdc764d9f5f13af6f4ad616e4267812947 \
  docker-credential-secretservice \
  "$HOME"/.local/bin

inst \
  https://github.com/M4RC3L05/denotag/releases/download/v4.6.19/denotag-x86_64-unknown-linux-gnu.tar.gz \
  0e6aac217947b655981c6e3e9cc24002fb5aee076ba152316e958d367a9891cf \
  denotag \
  "$HOME"/.local/bin \
  0

inst \
  https://github.com/mr-karan/doggo/releases/download/v1.1.3/doggo_1.1.3_Linux_x86_64.tar.gz \
  1cc8a80f64fe69de733e6d2efb397d7d20e75e254f8f23515349519c62aa0adf \
  doggo_1.1.3_Linux_x86_64/doggo \
  "$HOME"/.local/bin \
  1

inst \
  https://github.com/kubecolor/kubecolor/releases/download/v0.5.3/kubecolor_0.5.3_linux_amd64.tar.gz \
  7d19ca394cbfc3cc82f587222e10621ba527158deb6bc8b71a56f091156147de \
  kubecolor \
  "$HOME"/.local/bin \
  0

echo "==> Install command completions"
mkdir -vp "$HOME"/.local/share/bash-completion/completions
mkdir -vp "$HOME"/.config/fish/completions
doggo completions bash > "$HOME"/.local/share/bash-completion/completions/doggo
doggo completions fish > ~/.config/fish/completions/doggo.fish
kubecolor completion bash > "$HOME"/.local/share/bash-completion/completions/kubecolor
kubecolor completion fish > ~/.config/fish/completions/kubecolor.fish
