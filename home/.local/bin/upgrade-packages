#!/usr/bin/env sh

set -ex

PACKAGES_DIR="$HOME/.dotfiles/packages"
EGET_EXECUTABLES="$PACKAGES_DIR/eget-executables"

nix-channel --update
nix-env --install --file '<nixpkgs>' --attr nix cacert -I nixpkgs=channel:nixpkgs-unstable
home-manager switch

set +x
while IFS= read -r executable; do
  if [ -n "$executable" ]; then
    (set -x; eget $executable --upgrade-only)
  fi
done < "$EGET_EXECUTABLES"

set -x

mise upgrade

# https://github.com/NixOS/nixpkgs/issues/369472
mkdir -p ~/.config/fish/completions
mkdir -p ~/.local/share/bash-completion/completions
mise completion fish > ~/.config/fish/completions/mise.fish
mise completion bash > ~/.local/share/bash-completion/completions/mise.bash